unit_tests:
  - name: test_scd2_first_valid_from__full_refresh
    description: "Test that records with the initial loaded_at sets 'gyldig_fra' to the first_valid_from value"
    model: test_scd2
    overrides:
      macros:
        is_incremental: false
    given:
      - input: ref('test_hist')
        rows:
          - {
              _hist_record_hash: 1,
              _hist_loaded_at: "2024-01-01 00:00:00",
            }
    expect:
      rows:
        - {
            _hist_record_hash: 1,
            gyldig_fra: "1900-01-01 00:00:00",
          }

  - name: test_scd2_first_valid_to__incremental
    description: "Test that updating a record from with the initial loaded_at does not change 'gyldig_fra' from the first_valid_from value"
    model: test_scd2
    overrides:
      macros:
        is_incremental: true
      vars:
        this_name: test_scd2
    given:
      - input: this
        rows:
          - {
              _hist_record_hash: 1,
              _hist_entity_key_hash: 1,
              _hist_loaded_at: "2024-01-01 00:00:00",
              _hist_record_updated_at: "2024-01-01 01:00:00",
              _scd2_valid_from: "1900-01-01 00:00:00",
              _scd2_valid_to: "9999-01-01 23:59:59",
            }
      - input: ref('test_hist')
        rows:
          - {
              _hist_record_hash: 2,
              _hist_entity_key_hash: 1,
              _hist_loaded_at: "2024-01-02 00:00:00",
              _hist_record_updated_at: "2024-01-02 01:00:00",
            }
    expect:
      rows:
        - {
            pk_test_scd2: 1,
            gyldig_fra: "1900-01-01 00:00:00",
          }
        - {
            pk_test_scd2: 2,
            gyldig_fra: "2024-01-02 00:00:00",
          }
